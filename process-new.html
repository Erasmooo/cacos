<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CACOS • Novo Processo</title>
<link rel="stylesheet" href="style.css"/>
</head>
<body>
<header class="header">
  <div class="header-inner">
    <div class="brand">
      <img src="logo-cacos.jpg" alt="CACOS" style="height:28px"/>
      <span class="brand-name">CACOS</span>
    </div>
    <nav class="topnav">
      <a href="index.html">Dashboard</a>
      <a href="loans.html">Créditos</a>
      <a href="clients.html">Clientes</a>
      <a href="validate-internal.html">Validação Interna</a>
      <a href="validate-bank.html">Validação Banco</a>
      <a href="process-new.html">Novo Processo</a>
    </nav>
  </div>
</header>

<main class="main">
  <div class="container grid grid-2">
    <form class="card" id="form" autocomplete="off">
      <h2 class="card-title">Criar Processo • Dados do Cliente</h2>

      <!-- Identificação -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Identificação</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="nome" placeholder="Nome completo*" required/>
          <input class="input" name="telefone" placeholder="Telefone (+258 …)*" required/>
          <input class="input" type="email" name="email" placeholder="Email"/>
          <select class="select" name="estadoCivil">
            <option value="">Estado civil</option><option>Solteiro(a)</option><option>Casado(a)</option><option>União de facto</option><option>Divorciado(a)</option>
          </select>

          <select class="select" name="docTipo"><option value="">Tipo de documento</option><option>BI</option><option>Passaporte</option><option>DIRE</option></select>
          <input class="input" name="docNumero" placeholder="Nº documento*" required/>

          <label class="field"><span class="label">Validade do documento*</span>
            <input class="input" type="date" name="docValidade" required/></label>

          <label class="field"><span class="label">Data de nascimento*</span>
            <input class="input" type="date" name="nascimento" required/></label>

          <select class="select" name="genero"><option value="">Género</option><option>Feminino</option><option>Masculino</option><option>Outro</option></select>
        </div>
      </div>

      <!-- Endereço -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Endereço</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="morada" placeholder="Residência (Bairro, Rua, Nº)*" required/>
          <input class="input" name="bairro" placeholder="Bairro"/>
          <input class="input" name="cidade" placeholder="Cidade*" required/>
          <input class="input" name="provincia" placeholder="Província*" required/>
        </div>
      </div>

      <!-- Emprego & Rendimento -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Emprego & Rendimento</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="empregador" placeholder="Empregador / Actividade*" required/>
          <input class="input" name="empNUIT" placeholder="NUIT do empregador"/>
          <input class="input" name="organica" placeholder="Orgânica / Departamento"/>
          <input class="input" name="funcao" placeholder="Função"/>
          <input class="input" name="endEmp" placeholder="Endereço do empregador (Bairro, Rua, Nº)" style="grid-column:1/-1"/>
          <input class="input" name="sup1" placeholder="Supervisor 1"/>
          <input class="input" name="sup1tel" placeholder="Contacto supervisor 1 (+258 …)"/>
          <input class="input" name="sup2" placeholder="Supervisor 2"/>
          <input class="input" name="sup2tel" placeholder="Contacto supervisor 2 (+258 …)"/>
          <input class="input" type="number" min="0" step="0.01" name="rendimento" placeholder="Rendimento mensal (MZN)*" required/>
          <input class="input" type="number" min="0" step="0.01" name="despesas" placeholder="Despesas mensais (MZN)"/>
        </div>
      </div>

      <!-- PEP -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">PEP — Pessoa Politicamente Exposta</div>
        <div class="grid grid-2" style="gap:12px">
          <select class="select" id="pepStatus" name="pepStatus">
            <option value="">É PEP?</option><option value="nao" selected>Não</option><option value="sim">Sim</option>
          </select>
          <input class="input" id="pepCargo" name="pepCargo" placeholder="Cargo/ligação (preencher se PEP)" disabled/>
          <input class="input" id="pepEntidade" name="pepEntidade" placeholder="Entidade (preencher se PEP)" disabled/>
        </div>
        <div class="hint">Se o cliente for PEP (ou familiar próximo), assinalar “Sim” e indicar cargo/entidade.</div>
      </div>

      <!-- Banco & Pagamento -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Banco & Pagamento</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="banco" placeholder="Banco (ex.: Millennium BIM, BCI, Standard Bank)"/>
          <input class="input" name="nib" placeholder="NIB / IBAN"/>
          <input class="input" name="carteira" placeholder="Carteira móvel (M-Pesa, e-Mola)"/>
        </div>
      </div>

      <!-- Consultor -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Consultor (captura do processo)</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="consNome" placeholder="Nome do consultor*" required/>
          <input class="input" name="consTel" placeholder="Contacto do consultor (+258 …)*" required/>
          <input class="input" name="consBanco" placeholder="Banco do consultor (opcional)"/>
          <input class="input" name="consNib" placeholder="NIB do consultor (opcional)"/>
          <input class="input" name="consWallet" placeholder="Carteira móvel do consultor (opcional)" style="grid-column:1/-1"/>
        </div>
      </div>

      <!-- Referências -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Referências</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" name="ref1nome" placeholder="Referência 1 — Nome"/>
          <input class="input" name="ref1tel" placeholder="Referência 1 — Contacto (+258 …)"/>
          <input class="input" name="ref1rel" placeholder="Referência 1 — Parentesco/Ligação"/>
          <input class="input" name="ref2nome" placeholder="Referência 2 — Nome"/>
          <input class="input" name="ref2tel" placeholder="Referência 2 — Contacto (+258 …)"/>
          <input class="input" name="ref2rel" placeholder="Referência 2 — Parentesco/Ligação"/>
        </div>
      </div>

      <!-- Anexos -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Anexos (fotos/scan)</div>
        <div class="row" style="gap:10px">
          <div class="inline"><input id="attBiFrente" class="input" type="file" accept="image/*"/><span class="hint">BI/Pass (frente)</span></div>
          <div class="inline"><input id="attBiVerso"  class="input" type="file" accept="image/*"/><span class="hint">BI/Pass (verso)</span></div>
          <div class="inline"><input id="attResid"    class="input" type="file" accept="image/*,application/pdf"/><span class="hint">Comprovativo de residência</span></div>
          <div class="inline"><input id="attRend"     class="input" type="file" accept="image/*,application/pdf"/><span class="hint">Rendimentos (3 meses)</span></div>
        </div>
        <div class="hint">Em produção estes ficheiros vão para um storage; aqui guardamos em base64 para demonstração.</div>
      </div>

      <!-- Proposta de Crédito + cálculo -->
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">Proposta de Crédito</div>
        <div class="grid grid-2" style="gap:12px">
          <input class="input" id="montante" type="number" min="0" step="0.01" placeholder="Montante (MZN)*" required/>
          <select class="select" id="prazo"><option value="">Prazo (meses)*</option><option>6</option><option>9</option><option selected>12</option><option>18</option><option>24</option></select>
          <input class="input" id="taxa" type="number" min="0" step="0.01" placeholder="Taxa anual (%)*" value="24" required/>
          <input class="input" id="entrada" type="number" min="0" step="0.01" placeholder="Entrada (MZN) opcional"/>
          <input class="input" id="seguro" type="number" min="0" step="0.01" placeholder="Seguro mensal (% do principal)"/>
          <input class="input" id="servico" type="number" min="0" step="0.01" placeholder="Taxa de serviço mensal (%)"/>
          <select class="select" id="diaVenc"><option value="">Dia de vencimento</option><option>1</option><option>5</option><option>10</option><option>15</option><option>20</option><option>25</option></select>
          <select class="select" id="grace"><option value="0">Período de carência</option><option value="0">0 meses</option><option value="1">1 mês</option><option value="2">2 meses</option></select>
        </div>

<div class="card" style="margin-top:10px">
  <div class="card-title" style="margin-bottom:6px">Simulação</div>
  <div class="grid grid-3" style="gap:12px">
    <div class="kpi">
      <div class="title">Prestação (PMT)</div>
      <div class="value small" id="prest">—</div>
      <div class="sub small" id="breakdown">Inclui extras se definidos</div>
    </div>
    <div class="kpi">
      <div class="title">Total a pagar</div>
      <div class="value small" id="total">—</div>
      <div class="sub small" id="juros">Juros aproximados</div>
    </div>
    <div class="kpi">
      <div class="title">CET aprox.</div>
      <div class="value small" id="cet">—</div>
      <div class="sub small">Taxa efetiva anual</div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:10px">
  <div class="card-title" style="margin-bottom:6px">Elegibilidade (pré-análise)</div>
  <div class="grid grid-3" style="gap:12px">
    <div class="kpi">
      <div class="title">Rendimento mensal</div>
      <div class="value small" id="rendMensal">—</div>
    </div>
    <div class="kpi">
      <div class="title">Rendimento líquido</div>
      <div class="value small" id="rendLiquido">—</div>
      <div class="sub small">Despesas: <span id="despMensal">—</span></div>
    </div>
    <div class="kpi">
      <div class="title">Prestação máxima (35%)</div>
      <div class="value small" id="prestMax">—</div>
    </div>
  </div>
  <div class="grid grid-3" style="gap:12px;margin-top:8px">
    <div class="kpi">
      <div class="title">Prestação estimada</div>
      <div class="value small" id="prestView">—</div>
    </div>
    <div class="kpi">
      <div class="title">Rácio Dívida/Rendimento</div>
      <div class="value small" id="dti">—</div>
    </div>
    <div class="kpi">
      <div class="title">Decisão</div>
      <div class="value small"><span class="badge" id="decisao">Sem dados</span></div>
    </div>
  </div>
  <div class="hint">Regra base: prestação ≤ 35% do rendimento líquido (rendimento − despesas).</div>
</div>

      </div>

      <label class="inline" style="align-items:flex-start;margin:6px 0">
        <input type="checkbox" required style="margin-top:5px"/><span class="hint">Confirmo veracidade dos dados e autorizo o tratamento para análise de crédito.</span>
      </label>

      <div class="inline" style="margin-top:8px">
        <button class="btn-primary" type="submit">Guardar e Enviar para Validação</button>
        <button type="reset" class="btn-ghost" id="limpar">Limpar</button>
      </div>
      <div class="hint" style="margin-top:6px">Estado após submissão: <span class="badge info">EM VALIDAÇÃO (KYC)</span></div>
    </form>

    <!-- Recentes -->
    <div class="card">
      <h2 class="card-title">Processos recentes</h2>
      <div class="table-wrap"><table>
        <thead><tr><th>ID</th><th>Cliente</th><th>Estado</th><th>Última acção</th></tr></thead>
        <tbody id="recent"></tbody></table></div>
    </div>
  </div>
</main>

<nav class="footer-nav">
  <a class="active" href="process-new.html">Novo</a>
  <a href="validate-internal.html">Validação</a>
  <a href="clients.html">Clientes</a>
  <a href="index.html">Dash</a>
</nav>

<script src="storage.js"></script>
<script>
const AFFORD = 0.35;

/* === Cálculo PMT + extras === */
function calcPrestacao() {
  const p0 = Number(document.getElementById('montante').value || 0);
  const ent = Number(document.getElementById('entrada').value || 0);
  const n   = Number(document.getElementById('prazo').value || 0);
  const ta  = Number(document.getElementById('taxa').value || 0);
  const seg = Number(document.getElementById('seguro').value || 0) / 100;
  const srv = Number(document.getElementById('servico').value || 0) / 100;

  const principal = Math.max(p0 - ent, 0);
  const pmt = DBApi.pmt(principal, ta, n) || 0;
  const extras = principal * (seg + srv);
  const prest = pmt + extras;

  const total = prest * (n || 0);
  const juros = total - principal;

  // CET aprox (considera apenas taxa nominal -> efetiva)
  const iMensal = (ta/100)/12;
  const cetAnual = iMensal ? (Math.pow(1+iMensal,12)-1) : 0;

  // UI
  document.getElementById('prest').textContent = prest ? DBApi.fmtMZN(prest) : '—';
  document.getElementById('breakdown').textContent = pmt ? `PMT ${DBApi.fmtMZN(pmt)}${extras?` + extras ${DBApi.fmtMZN(extras)}`:''}` : 'Inclui extras se definidos';
  document.getElementById('total').textContent = total ? DBApi.fmtMZN(total) : '—';
  document.getElementById('juros').textContent = juros ? `Juros aprox.: ${DBApi.fmtMZN(juros)}` : 'Juros aproximados';
  document.getElementById('cet').textContent = cetAnual ? `${(cetAnual*100).toFixed(2)}% a.a.` : '—';

  return { prest, pmt, extras, principal, n };
}

/* === Elegibilidade === */
function calcElegibilidade(){
  const r = Number(document.querySelector('[name="rendimento"]')?.value || 0);
  const d = Number(document.querySelector('[name="despesas"]')?.value || 0);
  const liquido = Math.max(r - d, 0);

  const { prest } = calcPrestacao();
  const prestMax = liquido * AFFORD;
  const dti = (liquido>0 && prest) ? (prest/liquido) : 0;

  const set = (id, val) => document.getElementById(id).textContent = val;
  set('rendMensal', r ? DBApi.fmtMZN(r) : '—');
  set('despMensal', d ? `Despesas: ${DBApi.fmtMZN(d)}` : '—');
  set('rendLiquido', liquido ? DBApi.fmtMZN(liquido) : '—');
  set('prestMax', liquido ? DBApi.fmtMZN(prestMax) : '—');
  set('prestView', prest ? DBApi.fmtMZN(prest) : '—');
  set('dti', (prest && liquido) ? `${(dti*100).toFixed(1)}%` : '—');

  const badge = document.getElementById('decisao');
  badge.className = 'badge';
  if(!prest || !liquido){ badge.textContent = 'Sem dados'; return false; }
  if(prest <= prestMax){ badge.classList.add('ok'); badge.textContent = 'Elegível (pré-análise)'; return true; }
  badge.classList.add('err'); badge.textContent = 'Não elegível'; return false;
}

/* === Eventos === */
['montante','prazo','taxa','entrada','seguro','servico'].forEach(id=>{
  const el=document.getElementById(id); if(el) el.addEventListener('input', ()=>{ calcPrestacao(); calcElegibilidade(); });
});
['rendimento','despesas'].forEach(name=>{
  const el=document.querySelector(`[name="${name}"]`); if(el) el.addEventListener('input', calcElegibilidade);
});
document.getElementById('limpar').addEventListener('click', ()=> setTimeout(()=>{ calcPrestacao(); calcElegibilidade(); },0));
calcPrestacao(); calcElegibilidade();

/* === PEP toggle === */
pepStatus.addEventListener('change', ()=>{
  const on = pepStatus.value==='sim';
  pepCargo.disabled = pepEntidade.disabled = !on;
  if(!on){ pepCargo.value=''; pepEntidade.value=''; }
});

/* === Recentes === */
function renderRecent(){
  const procs = DBApi.listProcesses().slice(-12).reverse();
  const clients = DBApi.listClients(); const byId = Object.fromEntries(clients.map(c=>[c.id,c]));
  recent.innerHTML = procs.map(p=>{
    const c = byId[p.clientId]; const nome = c? c.nome : '(desconhecido)';
    const quando = new Date(p.updatedAt||p.createdAt).toLocaleString('pt-PT');
    const cls = p.state.includes('NÃO') ? 'badge err' : p.state.includes('VALIDAÇÃO') ? 'badge info' : p.state==='ATIVO' ? 'badge ok' : 'badge';
    return `<tr><td><a href="process.html?id=${p.id}">${p.id}</a></td><td>${nome}</td><td><span class="${cls}">${p.state}</span></td><td>${quando}</td></tr>`;
  }).join('') || `<tr><td colspan="4" class="hint">Sem processos.</td></tr>`;
}
renderRecent();

/* === Ficheiro → base64 (demo) === */
async function fileToDataURL(input){
  if(!input || !input.files || !input.files[0]) return null;
  const f = input.files[0];
  return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
}

/* === Submit (cria cliente + processo) === */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const get = n => document.querySelector(`[name="${n}"]`)?.value?.trim()||'';

  // Cliente (resumo)
  const cliente = {
    id: DBApi.genId('CLI'),
    nome:get('nome'), telefone:get('telefone'), email:get('email'),
    cidade:get('cidade'), provincia:get('provincia'),
    createdAt:Date.now()
  };
  const cl = DBApi.listClients(); cl.push(cliente); save(DB.clients, cl);

  // Simulação
  const m=Number(montante.value||0), n=Number(prazo.value||0), t=Number(taxa.value||0), ent=Number(entrada.value||0);
  const seg=Number(document.getElementById('seguro').value||0);
  const srv=Number(document.getElementById('servico').value||0);
  const { prest, pmt, extras, principal } = calcPrestacao();
  const elegivel = calcElegibilidade();

  // PEP
  const pep = { status: pepStatus.value||'nao', cargo: (pepCargo.value||'').trim(), entidade: (pepEntidade.value||'').trim() };

  // Consultor
  const consultor = { nome:get('consNome'), contacto:get('consTel'), banco:get('consBanco'), nib:get('consNib'), wallet:get('consWallet') };

  // Referências
  const referencias = [
    { nome:get('ref1nome'), tel:get('ref1tel'), rel:get('ref1rel') },
    { nome:get('ref2nome'), tel:get('ref2tel'), rel:get('ref2rel') }
  ];

  // Anexos (base64)
  const attachments = {
    biFrente: await fileToDataURL(document.getElementById('attBiFrente')),
    biVerso:  await fileToDataURL(document.getElementById('attBiVerso')),
    residencia: await fileToDataURL(document.getElementById('attResid')),
    rendimentos: await fileToDataURL(document.getElementById('attRend'))
  };

  // Processo
  const processo = {
    id: DBApi.genId('PRC'),
    clientId: cliente.id,
    state: elegivel ? 'EM VALIDAÇÃO (KYC)' : 'NÃO ELEGÍVEL (fora política)',
    proposta:{
      montante:m, prazoMeses:n, taxaAnual:t, entrada:ent,
      seguroPct:seg, servicoPct:srv, prestacao:prest||0, pmtBase:pmt||0, extras:extras||0,
      principal: principal||0, diaVenc: document.getElementById('diaVenc').value||'', grace: Number(document.getElementById('grace').value||0)
    },
    kyc:{
      estadoCivil:get('estadoCivil'),
      doc:{tipo:get('docTipo'), numero:get('docNumero'), validade:get('docValidade')},
      nascimento:get('nascimento'), genero:get('genero'),
      endereco:{morada:get('morada'), bairro:get('bairro'), cidade:get('cidade'), provincia:get('provincia')},
      emprego:{
        empregador:get('empregador'), nuit:get('empNUIT'), organica:get('organica'), funcao:get('funcao'),
        endereco:get('endEmp'),
        supervisores:[{nome:get('sup1'), tel:get('sup1tel')},{nome:get('sup2'), tel:get('sup2tel')}],
        rendimento:Number(get('rendimento')||0), despesas:Number(get('despesas')||0)
      },
      pagamentos:{ banco:get('banco'), nib:get('nib'), carteira:get('carteira') },
      referencias,
      pep
    },
    consultor,
    attachments,
    createdAt:Date.now(),
    updatedAt:Date.now()
  };

  const ps = DBApi.listProcesses(); ps.push(processo); save(DB.processes, ps);

  alert(`Processo ${processo.id} criado para ${cliente.nome}.\nDecisão preliminar: ${elegivel ? 'Elegível' : 'Não elegível'}.`);
  form.reset(); calcPrestacao(); calcElegibilidade(); renderRecent();
});
</script>
</body>
</html>
